#!/bin/bash
set -eou pipefail

url="${1:?url parameter required}"
audience="${2:?audience parameter required}"
requested_profile="${3:?profile parameter required}"
action="${4:?action parameter required}"
: "${TMPDIR:?TMPDIR environment variable required}"

additional_oidc_claims="pipeline_id,cluster_id,cluster_name,queue_id,queue_key"

# ignore unsupported actions without error
if [[ "${action}" != "get" ]]; then
    exit 0
fi

# Extract prefix and profile name using parameter expansion
# ${var%%:*} = part before first colon (prefix)
# ${var#*:} = part after first colon (profile name)
profile_prefix="${requested_profile%%:*}"
profile_name="${requested_profile#*:}"

# Validate profile format (must have colon separator)
if [[ "${profile_prefix}" == "${profile_name}" ]]; then
  echo "Error: invalid profile format '${requested_profile}'. Must be 'prefix:name' (e.g., 'pipeline:default', 'org:my-profile')." >&2
  exit 1
fi

# Validate profile name contains only allowed characters
if [[ ! "${profile_name}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
  echo "Error: invalid profile name '${profile_name}'. Must contain only alphanumeric characters, underscores, and hyphens." >&2
  exit 1
fi

# Validate profile prefix is recognized
case "${profile_prefix}" in
  pipeline|repo|org)
    # Valid prefix, continue
    ;;
  *)
    echo "Error: unrecognized profile prefix '${profile_prefix}'. Use 'pipeline:' or 'org:'." >&2
    exit 1
    ;;
esac

# read credential helper input from stdin
args="$(< /dev/stdin)"

script_dir=$(dirname "${BASH_SOURCE[0]}")
# shellcheck source=../lib/cache.bash
source "${script_dir}/../lib/cache.bash"

# caches the OIDC token for 5 minutes, so that successive calls to the credential helper use the existing token
if ! oidc_auth_token="$(cache_read "${BUILDKITE_JOB_ID}")"; then
  # timings are output to stderr, which Git ignores.
  TIMEFORMAT='[oidc = %2Rs]'
  time {
    oidc_auth_token="$(buildkite-agent oidc request-token --claim "${additional_oidc_claims}" --audience "${audience}")"
  }
  cache_write "${BUILDKITE_JOB_ID}" "${oidc_auth_token}"
fi

# Determine request path based on prefix
case "${profile_prefix}" in
  pipeline)
    request_path="git-credentials/${profile_name}"
    ;;
  repo)
    echo -e "\033[33mWarning: 'repo:' prefix is deprecated. Use 'pipeline:' instead. This will be removed in the next major version.\033[0m" >&2
    request_path="git-credentials/${profile_name}"
    ;;
  org)
    request_path="organization/git-credentials/${profile_name}"
    ;;
esac

# Request a token for the given repository from the remote server, using the
# OIDC JWT from the agent. The output of this request is in the expected format,
# so is sent to stdout to be read by git.
TIMEFORMAT='[token vendor = %2Rs]'

time curl --silent --show-error --fail \
  --request POST "${url}/${request_path}" \
  --data "${args}" \
  --header "Authorization: Bearer ${oidc_auth_token}" \
  --header "Content-Type: text/plain" \
  --header "Accept: text/plain"

